tdp_configurator:
  # aws ecr get-login-password --region eu-central-1 | docker login --username AWS --password-stdin 377668981663.dkr.ecr.eu-central-1.amazonaws.com && imgpkg describe -b $(kubectl get -n tap-install $(kubectl get package -n tap-install --field-selector spec.refName=tpb.tanzu.vmware.com -o name) -o jsonpath="{.spec.template.spec.fetch[0].imgpkgBundle.image}") -o yaml --tty=true | grep -A 1 "kbld.carvel.dev/id: harbor-repo.vmware.com/esback/configurator" | grep "image: " | sed 's/\simage: //g'
  image: 377668981663.dkr.ecr.eu-central-1.amazonaws.com/tap-images@sha256:001d3879720c2dc131ec95db6c6a34ff3c2f912d9d8b7ffacb8da08a844b740f
  config: |
    app:
      plugins:
        - name: '@vmware-tanzu/tdp-plugin-techinsights'
          version: '0.0.2'
        - name: '@vmware-tanzu/tdp-plugin-home'
          version: '0.0.2'
        - name: '@vmware-tanzu/tdp-plugin-stack-overflow'
          version: '0.0.2'
        - name: '@vmware-tanzu/tdp-plugin-backstage-sonarqube'
          version: '0.0.2'
        - name: '@vmware-tanzu/tdp-plugin-snyk'
          version: '0.0.2'
        - name: '@vmware-tanzu/tdp-plugin-github-actions'
          version: '0.0.2'
        - name: '@vmware-tanzu/tdp-plugin-backstage-jira'
          version: '0.0.2'
        - name: '@vmware-tanzu/tdp-plugin-prometheus'
          version: '0.0.2'
        - name: '@vmware-tanzu/tdp-plugin-backstage-grafana'
          version: '0.0.2'
    backend:
      plugins:
        - name: '@vmware-tanzu/tdp-plugin-techinsights-backend'
          version: '0.0.2'
        - name: '@vmware-tanzu/tdp-plugin-backstage-sonarqube-backend'
          version: '0.0.3'
  custom_image: harbor.main.emea.end2end.link/tap/tdp-configurator-tdp-configurator@sha256:4f59d3cab1e16c44a1b0596717532dfa9a310d1e4b82513986f60c3ea02cbaff
  overlay: |
    #@ load("@ytt:overlay", "overlay")
    #@overlay/match by=overlay.subset({"kind": "Deployment", "metadata": {"name": "server", "namespace": "tap-gui"}}), expects="1+"
    ---
    spec:
      template:
        spec:
          containers:
            #@overlay/match by=overlay.subset({"name": "backstage"}),expects="1+"
            #@overlay/match-child-defaults missing_ok=True
            - image: IMAGE-REFERENCE
            #@overlay/replace
              args:
              - -c
              - |
                export KUBERNETES_SERVICE_ACCOUNT_TOKEN="$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)"
                exec /layers/tanzu-buildpacks_node-engine-lite/node/bin/node portal/dist/packages/backend  \
                --config=portal/app-config.yaml \
                --config=portal/runtime-config.yaml \
                --config=/etc/app-config/app-config.yaml